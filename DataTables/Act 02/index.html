<!DOCTYPE html>
<html lang="en">
<head>
    <title>Buttons + Responsive</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS + JQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.0/css/bootstrap.min.css" integrity="sha384-SI27wrMjH3ZZ89r4o+fGIJtnzkAnFs3E4qz9DIYioCQ5l9Rd/7UAa8DHcaL8jkWt" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

    <!-- DataTables -->
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.20/datatables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css"/>

    <!-- DataTables Select -->
    <script src="https://cdn.datatables.net/select/1.2.7/js/dataTables.select.min.js"></script>

    <!-- DataTables Buttons -->
    <script src="https://cdn.datatables.net/buttons/1.6.1/js/dataTables.buttons.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.6.1/js/buttons.bootstrap4.min.js"/>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.bootstrap4.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.6.1/css/buttons.bootstrap4.min.css"/>
    <script src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.flash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js"></script>

    <!-- DataTables Responsive -->
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.3/css/responsive.dataTables.min.css"/>
    <script src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>

</head>
<body>
<div class="container-fluid">
    <h1 class="offset-md-1"> Persones </h1>
    <br/>
    <div class="row">
        <div class="col-6 col-4 col-lg-2 my-2 my-lg-0 px-0">
            <form class="bg-primary p-3 rounded-right text-white">
                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="checkBEdat">
                    <label class="custom-control-label" for="checkBEdat">Edat</label>
                </div>
                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="checkBExp">
                    <label class="custom-control-label" for="checkBExp">Experiencia</label>
                </div>
                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="checkBSexe">
                    <label class="custom-control-label" for="checkBSexe">Sexe</label>
                </div>
            </form>
        </div>
        <div class="col-md-10 offset-1 offset-lg-0">
            <div class="container-fluid">
                <div class="row mb-2 ">
                    <div class="col-10 col-sm-7" id="buttonsZone"></div>
                    <!--Dropdown-->
                    <div class="col-2 col-sm-5 d-flex flex-row-reverse">
                        <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownSexe" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-filter"></i> Sexe
                        </button>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownSexe">
                            <a class="dropdown-item" id="dropT" href="#">Tothom</a>
                            <a class="dropdown-item" id="dropM" href="#">Home</a>
                            <a class="dropdown-item" id="dropF" href="#">Dona</a>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col text-center">
                        <table id="table" class="display nowrap table table-striped table-bordered" style="width:100%">
                            <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>Edat</th>
                                <th>Experiencia</th>
                                <th>Sexe</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col d-flex flex-row" id="exportButtons"></div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modal Insert -->
<div id="modalInsert" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">

            <!-- header modal -->
            <div class="modal-header">
                <h5 class="modal-title" id="modalInsertLabel">Afegir Persona</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <!-- body modal -->
            <div class="modal-body">
                <form role="form" name="formEdita" method="get" id="insertForm">
                    <div class="row">
                        <div class="col-md-6">
                            <label>Nom:</label>
                            <input id="insertNom" type="text" class="form-control" placeholder="Nom" name="nom">
                        </div>
                        <div class="col-md-6">
                            <label>Email:</label>
                            <input id="insertEmail" type="email" class="form-control" placeholder="example@gmail.com" name="email">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label>Edat:</label>
                            <input id="insertEdat" type="text" class="form-control" placeholder="Edat" name="edat">
                        </div>
                        <div class="col-md-6">
                            <label>Experiencia:</label>
                            <input id="insertExp" type="text" class="form-control" placeholder="Experiencia" name="exp">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6" id="insertSexeBox">
                            <label>Sexe:</label><br/>
                        </div>
                    </div>
                </form>
            </div>

            <!-- footer modal -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Tancar</button>
                <button id="insertPersona" type="submit" class="btn btn-primary">Afegir</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Edit/Delete -->
<div id="modalEdit" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">

            <!-- header modal -->
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditLabel">Editar Persona</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <!-- body modal -->
            <div class="modal-body">
                <form role="form" name="formEdita" method="get" id="editForm">
                    <div class="row">
                        <div class="col-md-6">
                            <label>Nom:</label>
                            <input id="editNom" type="text" class="form-control" placeholder="Nom" name="nom">
                        </div>
                        <div class="col-md-6">
                            <label>Email:</label>
                            <input id="editEmail" type="email" class="form-control" placeholder="example@gmail.com" readonly="readonly" name="email">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label>Edat:</label>
                            <input id="editEdat" type="text" class="form-control" placeholder="Edat" name="edat">
                        </div>
                        <div class="col-md-6">
                            <label>Experiencia:</label>
                            <input id="editExp" type="text" class="form-control" placeholder="Experiencia" name="exp">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6" id="editSexeBox">
                            <label>Sexe:</label><br/>
                        </div>
                    </div>
                </form>
            </div>

            <!-- footer modal -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Tancar</button>
                <button id="editPersona" type="submit" class="btn btn-primary">Confirmar canvis</button>
                <button id="deletePersona" type="submit" class="btn btn-danger">Eliminar Persona</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        cargaSexes("#insertSexeBox");
        cargaSexes("#editSexeBox");

        var dt = loadPersones();

        $('#insertPersona').click(function(){insertPersona(dt)});
        $('#editPersona').click(function(){updatePersona(dt)});
        $('#deletePersona').click(function(){deletePersona(dt)});

        $('#dropT').click(function(){filterSexe(dt, null)});
        $('#dropM').click(function(){filterSexe(dt, "M")});
        $('#dropF').click(function(){filterSexe(dt, "F")});

        $('#checkBEdat').click(function(){hideColumn(dt, "2")});
        $('#checkBExp').click(function(){hideColumn(dt, "3")});
        $('#checkBSexe').click(function(){hideColumn(dt, "4")});
    });


    function loadPersones() {
        let dt = $('#table').DataTable({
            dom: 'Brtp',
            ajax: {
                url: 'getPersones.php',
                dataSrc: '',
                type: "get",
            },
            columns: [
                {data: 'Nom'},
                {data: 'Email'},
                {data: 'Edat'},
                {data: 'Experiencia'},
                {data: 'Sexe'}],
            select: true,

            responsive: true,
            buttons: [
                {
                    extend: 'copy',
                    className: 'btn-primary',
                    text: '<i class="fas fa-copy"></i>',
                    init: removeSecondaryButtons
                },
                {
                    extend: 'csv',
                    className: 'btn-primary',
                    text: '<i class="fas fa-file-csv"></i>',
                    init: removeSecondaryButtons
                },
                {
                    extend: 'excel',
                    className: 'btn-primary',
                    text: '<i class="fas fa-file-excel"></i>',
                    init: removeSecondaryButtons
                },
                {
                    extend: 'pdf',
                    className: 'btn-primary',
                    text: '<i class="fa fa-file-pdf"></i>',
                    init: removeSecondaryButtons
                },
                {
                    extend: 'print',
                    className: 'btn-primary',
                    text: '<i class="fas fa-print"></i>',
                    init: removeSecondaryButtons
                }
            ]
            //Error de compatibilitat amb els botons. No els deixa seleccionar
            // language: {
            //     url: "//cdn.datatables.net/plug-ins/1.10.19/i18n/Catalan.json"
            // }
        });
        dt.buttons().container().appendTo('#exportButtons');

        loadButtons(dt);

        checkEdat(dt);
        checkExperiencia(dt);

        return dt;
    }

    //Order Buttons
    function loadButtons(table){
        new $.fn.dataTable.Buttons( table, {
            buttons: [
                {
                    text: '<i class="fas fa-user-edit"></i> Editar',
                    action: function (e, dt, node, config) {
                        loadModal(dt.row({selected: true}));
                        $("#modalEdit").modal();
                    },
                    className: 'btn-primary',
                    init: removeSecondaryButtons
                },
                {
                    text: '<i class="fas fa-user-plus"></i> Afegir',
                    action: function (e, dt, node, config) {
                        $("#modalInsert").modal();
                    },
                    className: 'btn-primary',
                    init: removeSecondaryButtons
                },
                {
                    text: '<i class="fas fa-user-minus"></i> Eliminar',
                    action: function (e, dt, node, config) {
                        dt.buttons().remove();
                    },
                    className: 'btn-primary',
                    init: removeSecondaryButtons
                }
            ]
        });

        table.buttons( 1, null ).container().appendTo("#buttonsZone");
    }

    //Color Cells
    function checkEdat(t){
        t.on( 'draw', function () {
            t.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
                var data = this.data();
                var row = $(this.node());
                if(data['Edat']<18){
                    row.find('td:eq(2)').css('background-color', '#F6A5A5');
                }
                else if(data['Edat']>64){
                    row.find('td:eq(2)').css('background-color', '#F6F0A5');
                }
                else {
                    row.find('td:eq(2)').css('background-color', '#A9FEB4');
                }
            } );
        } );
    }
    function checkExperiencia(t){
        t.on( 'draw', function () {
            t.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
                var data = this.data();
                var row = $(this.node());
                if(data['Experiencia']<6){
                    row.find('td:eq(3)').css('background-color', '#F6F0A5');
                }
            } );
        } );
    }

    //Dropdown Hide
    function filterSexe(t, sexe) {
        t.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
            var data = this.data();
            var row = $(this.node());
            row.hide();
            if(data['Sexe'] !== sexe){
                row.show();
            }
        } );
    }

    //Hide column with checkboxes
    function hideColumn(t, col){
        var column = t.column(col);
        column.visible(!column.visible());
    }

    function removeSecondaryButtons(api, node, config){
        $(node).removeClass('btn-secondary');
    }

    //Activitat 04

    function cargaSexes(element){
        $.ajax({
            type: "GET",
            url: "getSexes.php",
            success: function(response) {
                let text = "";
                $.each(response, function () {
                    text += '<div class="form-check form-check-inline"> ' +
                                '<input class="form-check-input" type="radio" name="sexe" id="insert' + this["id"] + '" value="' + this["id"] + '"> ' +
                                '<label class="form-check-label" for="insert' + this["id"] + '">' + this["Nom"].charAt(0).toUpperCase() +  this["Nom"].substr(1).toLowerCase() + '</label> ' +
                            '</div> ';
                });
                $(element).append(text);
            }
        });
    }

    //Insert
    function insertPersona(table){
        $('#modalInsert').modal('toggle');
        $.ajax({
            type: "post",
            url: "insertPersona.php",
            data:{"nom": $("#insertNom").val(), "email": $("#insertEmail").val(), "edat": $("#insertEdat").val(), "exp": $("#insertExp").val(), "sexe": $('#insertSexeBox').find('input:radio[name=sexe]:checked').val()},
            success: function (response) {
                if(response == true) {
                    table.ajax.reload();
                    alert("S'ha Afegit correctament a " + $('#insertNom').val());
                }
            }
        }).fail(function() {
            alert("Ha hagut un error!");
        });
        //No sé perqué dona l'error a ajax en lloc de retornar-lo com resposta
    }

    //Update/Delete
    function loadModal(row){
        let persona = row.data();

        $("#editNom").val(persona.Nom);
        $("#editEmail").val(persona.Email);
        $("#editEdat").val(persona.Edat);
        $("#editExp").val(persona.Experiencia);
        $('#editSexeBox').find('input:radio[name=sexe]').filter("[value=" + persona.Sexe + "]").prop('checked', true);
    }

    function updatePersona(table){
        $('#modalEdit').modal('toggle');
        $.ajax({
            type: "post",
            url: "updatePersona.php",
            data:{"nom": $("#editNom").val(), "email": $("#editEmail").val(), "edat": $("#editEdat").val(), "exp": $("#editExp").val(), "sexe": $('#editSexeBox').find('input:radio[name=sexe]:checked').val()},
            success: function (response) {
                if(response == true) {
                    table.ajax.reload();
                    alert("S'ha actualitzat correctament a " + $('#editNom').val());
                }
            }
        }).fail(function() {
            alert("Ha hagut un error!");
        });
        //No sé perqué dona l'error a ajax en lloc de retornar-lo com resposta
    }

    function deletePersona(table){
        $('#modalEdit').modal('toggle');
        $.ajax({
            type: "post",
            url: "deletePersona.php",
            data:{"email": $("#editEmail").val()},
            success: function (response) {
                if(response == true) {
                    table.ajax.reload();
                    alert("S'ha eliminat correctament a " + $('#editNom').val());
                }
            }
        }).fail(function() {
            alert("Ha hagut un error!");
        });
        //No sé perqué dona l'error a ajax en lloc de retornar-lo com resposta
    }

</script>
</body>
</html>